{% extends "base.html" %}
{% block title %}Index Page{%endblock%}
{%block content%}
<script src="{{ url_for('static', filename='activePage.js') }}" defer></script>
<link rel="stylesheet" type="text/css" href="/css/style.css">
<style>
#main::before {
    content: ""; /* Pseudo-element needs content */
    position: absolute; /* Position it over the parent element */
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-image: url('/img/main_bg.png'); /* Your background image */
    background-size: cover;
    background-position: center;
    opacity: 1; /* Set the opacity of the background image */
    z-index: -1; /* Send the background behind the content */
}
h1 {
    color: #333;
}
#button-container {
    display: flex;
    justify-content: space-around;
    margin-top: 2rem;
}
.button-wrapper {
    display: flex;
    flex-direction: column;
    align-items: center;
}
button {
    background: none;
    border: none;
    cursor: pointer;
    transition: transform 0.3s ease;
}
button:hover {
    transform: scale(1.1);
}
button img {
    width: 64px;
    height: 64px;
}
label {
    margin-top: 0.5rem;
    font-size: 1rem;
    color: #555;
}
#transcription, #summary {
    margin-top: 1rem;
    text-align: left;
    border: 1px solid #ddd;
    padding: 1rem;
    border-radius: 5px;
    max-height: 200px;
    overflow-y: auto;
}
</style>
    <nav id="header">
        <div id="T_L">
            <div id="head_logo">
                <img src="/img/logo.png" alt="Logo" >
            </div>
            <div id="title">
                NOTE<span id="D">D</span>
            </div>
        </div>
        <div id="action_bar">
            <div class="action">
                <a onclick="location.href='{{ url_for('index') }}'">HOME</a>
            </div>
            <div class="action">
                <a onclick="location.href='{{ url_for('notes') }}'">CREATE NEW</a>
            </div>
            <div class="action">
                <a onclick="location.href='{{ url_for('contact') }}'">CONTACT US</a>
            </div>
            <div class="action">
                <a onclick="location.href='{{ url_for('contribution') }}'">CONTRIBUTION</a>
            </div>
        </div>
        <div id="L_G">
            {% if not current_user.is_authenticated %}
            <div id="login_btn">
                <a onclick="location.href='{{ url_for('login') }}'">Login</a>
            </div>
            {% else %}
            <div id="login_btn">
                <a onclick="location.href='{{ url_for('logout') }}'">Logout</a>
            </div>
            <div id="get_started">
                <a href="#">Get Started</a>
            </div>
            {% endif %}
        </div>
    </nav>
    <main id="m">
        <div id="main">
            <h1 id="txt">Create New Note</h1>
            <div id="button-container">
                <div class="button-wrapper" id="record">
                    <button id="recordButton">
                        <img src="/img/Record-icon.png" alt="Record">
                    </button>
                    <label for="recordButton">Record</label>
                </div>
                <div class="button-wrapper" id="upload">
                    <button onclick="document.getElementById('audioFileInput').click()">
                        <img src="/img/Upload-Icon.png" alt="Upload">
                    </button>
                    <label for="audioFileInput">Upload</label>
                    <input type="file" id="audioFileInput" accept="audio/*" style="display: none;">
                </div>
            </div>
            <h3>Transcription:</h3>
            <div id="transcription"></div>
        </div>
    </main>
    <footer>
        <p>&copy; 2024 Noted. All rights reserved.</p>
    </footer>
    <script>
        let mediaRecorder;
        let audioChunks = [];
        let recognition;
        let isRecording = false;
        let transcriptDeferCommit = '';

        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onresult = (event) => {
                let interimTranscript = '';
                let finalTranscript = '';

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                updateTranscription(finalTranscript, interimTranscript);
            };

            recognition.onend = () => {
                if (isRecording) {
                    recognition.start();
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error', event.error);
            };
        } else {
            console.log('Web Speech API is not supported in this browser.');
        }

        function updateTranscription(finalTranscript, interimTranscript) {
            if (finalTranscript) {
                transcriptDeferCommit += finalTranscript + ' ';
            }
            
            const transcriptionDiv = document.getElementById('transcription');
            transcriptionDiv.innerHTML = transcriptDeferCommit + 
                '<i style="color: #999;">' + interimTranscript + '</i>';
            transcriptionDiv.scrollTop = transcriptionDiv.scrollHeight;
        }

        async function generateSummary(text) {
            try {
                const response = await fetch('/summarize', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ text: text }),
                });
                const data = await response.json();
                if (data.error) {
                    throw new Error(data.error);
                }
                // Redirect to the summary page
                window.location.href = `/summary?summary=${encodeURIComponent(data.summary)}`;
            } catch (error) {
                console.error('Error generating summary:', error);
                alert('Error generating summary. Please try again.');
            }
        }

        document.getElementById('recordButton').addEventListener('click', async () => {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        console.log("Recording finished. Audio URL:", audioUrl);
                        audioChunks = [];
                    };

                    mediaRecorder.start();
                    if (recognition) {
                        recognition.start();
                    }
                    isRecording = true;
                    document.querySelector('#record label').textContent = 'Stop';
                } catch (err) {
                    console.error('Error accessing the microphone', err);
                }
            } else {
                mediaRecorder.stop();
                if (recognition) {
                    recognition.stop();
                }
                mediaRecorder = null;
                isRecording = false;
                document.querySelector('#record label').textContent = 'Record';
                
                // Generate summary after stopping the recording
                if (transcriptDeferCommit.trim()) {
                    await generateSummary(transcriptDeferCommit);
                }
                
                transcriptDeferCommit = '';
            }
        });





    </script>
    
{%endblock%}